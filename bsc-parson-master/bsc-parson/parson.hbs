#ifndef BISHENG_C_SAFETY_PARSON_H
#define BISHENG_C_SAFETY_PARSON_H

#define PARSON_VERSION_MAJOR 1
#define PARSON_VERSION_MINOR 5
#define PARSON_VERSION_PATCH 3

#define PARSON_VERSION_STRING "1.5.3"

#include "string.hbs"
#include <stddef.h>

owned struct JSON_Object;
owned struct JSON_Array;
owned struct JSON_Value;

unsafe void free_JSON_Object(JSON_Object* owned jo);
unsafe void free_JSON_Array(JSON_Array* owned ja);

enum json_value_type {
	JSONError   = -1,
    JSONNull    = 1,
    JSONString  = 2,
    JSONNumber  = 3,
    JSONObject  = 4,
	JSONArray   = 5,
	JSONBoolean = 6
};
typedef int JSON_Value_Type;

enum json_result_t {
	JSONSuccess = 0,
	JSONFailure = -1
};
typedef int JSON_Status;

// FIXME: it's too costy to replace union with struct
owned struct JSON_Value_Value {
public:
    String              string;
    double              number;
    JSON_Object* owned  object;
    JSON_Array*  owned  array;
    int                 boolean;
    int                 null;

    ~JSON_Value_Value(JSON_Value_Value this) {
        free_JSON_Object(this.object);
        free_JSON_Array(this.array);
        // AUTO INSERT ~String(this.string)
    }
};

owned struct JSON_Value {
public:
    JSON_Value_Type  type;
    JSON_Value_Value value;

    ~JSON_Value(JSON_Value this) {
        // AUTO INSERT: ~JSON_Value_Value(this.value)
    }
};

owned struct JSON_Object {
public:
    Vec<size_t>        cells;
    Vec<unsigned long> hashes;
    Vec<String>        names;
    Vec<JSON_Value>    values;
    Vec<size_t>        cell_ixs;
    size_t             count;
    size_t             item_capacity;
    size_t             cell_capacity;

    ~JSON_Object(JSON_Object this) {
        // AUTO INSERT: ~Vec(this.cells)
        // AUTO INSERT: ~Vec(this.hashes)
        // AUTO INSERT: ~Vec(this.names)
        // AUTO INSERT: ~Vec(this.values)
        // AUTO INSERT: ~Vec(this.cell_ixs)
    }
};

owned struct JSON_Array {
public:
    Vec<JSON_Value>  items;

    ~JSON_Array(JSON_Array this) {
        // AUTO INSERT: ~Vec(this.items)
    }
};

safe JSON_Value json_parse_file(String filename);
safe void JSON_Value::json_parse_string(JSON_Value* borrow this, const String* borrow string);

safe _Bool  JSON_Value::equals(JSON_Value* borrow this, JSON_Value* borrow other);

safe _Bool JSON_Value::validate(JSON_Value* borrow this, JSON_Value* borrow schema);

/*------------------------------- JSON Object --------------------------------*/
safe JSON_Value* borrow   JSON_Object::get_value  (JSON_Object* borrow this, const String* borrow name);
safe String* borrow       JSON_Object::get_string (JSON_Object* borrow this, const String* borrow name);
safe JSON_Object* borrow  JSON_Object::get_object (JSON_Object* borrow this, const String* borrow name);
safe JSON_Array* borrow   JSON_Object::get_array  (JSON_Object* borrow this, const String* borrow name);
safe double               JSON_Object::get_number (JSON_Object* borrow this, const String* borrow name); /* returns 0 on fail */
safe int                  JSON_Object::get_boolean(JSON_Object* borrow this, const String* borrow name); /* returns -1 on fail */

unsafe JSON_Value*        JSON_Object::dotget_value  (JSON_Object* borrow this, const String* name);
unsafe String*            JSON_Object::dotget_string (JSON_Object* borrow this, const String* name);
unsafe JSON_Object*       JSON_Object::dotget_object (JSON_Object* borrow this, const String* name);
unsafe JSON_Array*        JSON_Object::dotget_array  (JSON_Object* borrow this, const String* name);
unsafe double             JSON_Object::dotget_number (JSON_Object* borrow this, const String* name); /* returns 0 on fail */
unsafe int                JSON_Object::dotget_boolean(JSON_Object* borrow this, const String* name); /* returns -1 on fail */

safe size_t               JSON_Object::get_count(const JSON_Object* borrow this);
safe const String* borrow JSON_Object::get_name(const JSON_Object* borrow this, size_t index);
safe JSON_Value* borrow   JSON_Object::get_value_at(JSON_Object* borrow this, size_t index);

safe _Bool                JSON_Object::has_value(const JSON_Object* borrow this, const String* borrow name);
safe _Bool                JSON_Object::has_value_of_type(JSON_Object* borrow this, const String* borrow name, JSON_Value_Type type);

unsafe _Bool              JSON_Object::dothas_value(JSON_Object* borrow this, const String* name);
unsafe _Bool              JSON_Object::dothas_value_of_type(JSON_Object* borrow this, const String* name, JSON_Value_Type type);

safe void JSON_Object::set_value(JSON_Object* borrow this, String name, JSON_Value value);
safe void JSON_Object::set_string(JSON_Object* borrow this, String name, String string);
safe void JSON_Object::set_number(JSON_Object* borrow this, String name, double number);
safe void JSON_Object::set_boolean(JSON_Object* borrow this, String name, int boolean);
safe void JSON_Object::set_null(JSON_Object* borrow this, String name);

safe void JSON_Object::remove(JSON_Object* borrow this, const String* borrow name);

safe void JSON_Object::clear(JSON_Object* borrow this);

/*------------------------------- JSON Array --------------------------------*/
safe JSON_Value* borrow JSON_Array::get_value     (JSON_Array* borrow this, size_t index);
safe String* borrow     JSON_Array::get_string    (JSON_Array* borrow this, size_t index);
safe size_t             JSON_Array::get_string_len(JSON_Array* borrow this, size_t index);
safe JSON_Object* borrow JSON_Array::get_object   (JSON_Array* borrow this, size_t index);
safe JSON_Array* borrow JSON_Array::get_array     (JSON_Array* borrow this, size_t index);
safe double             JSON_Array::get_number    (JSON_Array* borrow this, size_t index); /* returns 0 on fail */
safe int           		JSON_Array::get_boolean   (JSON_Array* borrow this, size_t index); /* returns -1 on fail */
safe size_t        		JSON_Array::get_count     (const JSON_Array* borrow this);

safe JSON_Status JSON_Array::remove(JSON_Array* borrow this, size_t i);

safe JSON_Status JSON_Array::replace_value  (JSON_Array* borrow this, size_t i, JSON_Value value);
safe JSON_Status JSON_Array::replace_string (JSON_Array* borrow this, size_t i, String string);
safe JSON_Status JSON_Array::replace_number (JSON_Array* borrow this, size_t i, double number);
safe JSON_Status JSON_Array::replace_boolean(JSON_Array* borrow this, size_t i, int boolean);
safe JSON_Status JSON_Array::replace_null   (JSON_Array* borrow this, size_t i);

safe JSON_Status JSON_Array::clear(JSON_Array* borrow this);

safe JSON_Status JSON_Array::append_value  (JSON_Array* borrow this, JSON_Value value);
safe JSON_Status JSON_Array::append_string (JSON_Array* borrow this, String string);
safe JSON_Status JSON_Array::append_number (JSON_Array* borrow this, double number);
safe JSON_Status JSON_Array::append_boolean(JSON_Array* borrow this, int boolean);
safe JSON_Status JSON_Array::append_null   (JSON_Array* borrow this);

/*------------------------------- JSON Value --------------------------------*/
safe void JSON_Value::init		  (JSON_Value* borrow this);
safe void JSON_Value::init_object (JSON_Value* borrow this);
safe void JSON_Value::init_array  (JSON_Value* borrow this);
safe void JSON_Value::init_string (JSON_Value* borrow this, String string);
safe void JSON_Value::init_number (JSON_Value* borrow this, double number);
safe void JSON_Value::init_boolean(JSON_Value* borrow this, int boolean);
safe void JSON_Value::init_null   (JSON_Value* borrow this);

safe JSON_Value_Type 	 JSON_Value::get_type      (const JSON_Value* borrow this);
safe JSON_Object* borrow JSON_Value::get_object    (JSON_Value* borrow this);
safe JSON_Array* borrow  JSON_Value::get_array     (JSON_Value* borrow this);
safe String* borrow      JSON_Value::get_string    (JSON_Value* borrow this);
safe size_t              JSON_Value::get_string_len(const JSON_Value* borrow this);
safe double              JSON_Value::get_number    (const JSON_Value* borrow this);
safe int             	 JSON_Value::get_boolean   (const JSON_Value* borrow this);

/*--------------------------- JSON Serialization ----------------------------*/
safe void json_dump(JSON_Value* borrow value);

#endif
